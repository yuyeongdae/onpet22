<?php session_start();
if (isset($_SESSION['user_id']) && $_SESSION['role'] === 'admin' && basename($_SERVER['PHP_SELF']) === 'admin.php') {
  // ê´€ë¦¬ì í˜ì´ì§€ ì ‘ê·¼ ë¡œê·¸ ê¸°ë¡ ë˜ëŠ” ë¦¬ë””ë ‰ì…˜ ìœ ì§€ ê°€ëŠ¥
} elseif (basename($_SERVER['PHP_SELF']) === 'admin.php') {
  header('Location: login.html');
  exit;
} ?>
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì˜¨ë§ˆë£¨í« - í”„ë¦¬ë¯¸ì—„ ë°˜ë ¤ë™ë¬¼ ê°„ì‹</title>
  <link rel="stylesheet" href="style.css" />
  <script defer src="script.js"></script>
  <script defer src="webauthn.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
  <!-- í—¤ë” -->
  <header class="navbar">
    <div class="container">
      <a href="#" class="logo">ì˜¨ë§ˆë£¨í«</a>
      <nav>
        <ul class="nav-links">
          <li><a href="#home">í™ˆ</a></li>
          <li><a href="#about">ë¸Œëœë“œ</a></li>
          <li><a href="#products">ì œí’ˆ</a></li>
          <li><a href="#subscribe">ì •ê¸°êµ¬ë…</a></li>
          <li><a href="#contact">ë¬¸ì˜</a></li>
          <li><a href="product-detail.html">ì œí’ˆìƒì„¸</a></li>
          <li><a href="login.html">ë¡œê·¸ì¸</a></li>
          <li><a href="signup.html">íšŒì›ê°€ì…</a></li>
          <li><a href="#dashboard">ë‚´ ë¶„ì„</a></li>
          <?php if (isset($_SESSION['role']) && $_SESSION['role'] === 'admin'): ?>
            <li><a href="admin.php">ê´€ë¦¬ì</a></li>
          <?php endif; ?>
          <?php if (isset($_SESSION['username'])): ?>
            <li><a href="logout.php">ë¡œê·¸ì•„ì›ƒ (<?php echo htmlspecialchars($_SESSION['username']); ?>)</a></li>
          <?php else: ?>
            <li><a href="login.html">ë¡œê·¸ì¸</a></li>
            <li><a href="signup.html">íšŒì›ê°€ì…</a></li>
          <?php endif; ?>
        </ul>
      </nav>
    </div>
  </header>

  <!-- íˆì–´ë¡œ ì„¹ì…˜ -->
  <section id="home" class="hero">
    <div class="hero-content">
      <h1>í”„ë¦¬ë¯¸ì—„ ë°˜ë ¤ë™ë¬¼ ê°„ì‹</h1>
      <p>ì¥ì–´ ë¶€ì‚°ë¬¼ê³¼ ê³ ì°½ íŠ¹ì‚°í’ˆì˜ ê±´ê°•í•œ ì¡°í™”</p>
      <a href="#products" class="btn">ì œí’ˆ ë³´ê¸°</a>
    </div>
  </section>

  <!-- ë¸Œëœë“œ ì†Œê°œ -->
  <section id="about" class="about section">
    <div class="container">
      <h2>ë¸Œëœë“œ ì´ì•¼ê¸°</h2>
      <p>ê³ ì°½êµ°ì—ì„œ ì‹œì‘ëœ ì¥ì–´ ë¶€ì‚°ë¬¼ ê¸°ë°˜ì˜ ì¹œí™˜ê²½ ë°˜ë ¤ë™ë¬¼ ê°„ì‹ ë¸Œëœë“œ. ì§€ì—­ ë†ì‚°ë¬¼ê³¼ì˜ ìœµí•©ìœ¼ë¡œ ì§€ì†ê°€ëŠ¥í•œ ê±´ê°• ê°„ì‹ì„ ë§Œë“­ë‹ˆë‹¤.</p>
    </div>
  </section>

  <!-- ì œí’ˆ ì†Œê°œ -->
  <section id="products" class="products section">
    <div class="container">
      <h2>ì œí’ˆ</h2>
      <div class="product-grid">
        <div class="product-card">
          <img src="images/treat.jpg" alt="íŠ¸ë¦¿í˜• ê°„ì‹">
          <button onclick="addToCart('íŠ¸ë¦¿í˜• ê°„ì‹')" class="btn" style="margin-top:10px;">ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
          <h3>íŠ¸ë¦¿í˜• ê°„ì‹</h3>
          <p>ì¥ì–´ ë¶€ì‚°ë¬¼ë¡œ ë§Œë“  ì˜ì–‘ ê°„ì‹</p>
        </div>
        <div class="product-card">
          <img src="images/stick.jpg" alt="ìŠ¤í‹±í˜• ê°„ì‹">
          <button onclick="addToCart('ìŠ¤í‹±í˜• ê°„ì‹')" class="btn" style="margin-top:10px;">ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
          <h3>ìŠ¤í‹±í˜• ê°„ì‹</h3>
          <p>ë³µë¶„ì, ë•…ì½©ì„ ë‹´ì€ ìŠ¤í‹± ê°„ì‹</p>
        </div>
        <div class="product-card">
          <img src="images/bone.jpg" alt="ê±´ì¡° ë¼ˆí˜• ê°„ì‹">
          <button onclick="addToCart('ê±´ì¡° ë¼ˆí˜• ê°„ì‹')" class="btn" style="margin-top:10px;">ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
          <h3>ê±´ì¡° ë¼ˆí˜• ê°„ì‹</h3>
          <p>êµ¬ê°• ê±´ê°•ì— ë„ì›€ì„ ì£¼ëŠ” ê°„ì‹</p>
        </div>
      </div>
    </div>
  </section>

  <!-- ì •ê¸°êµ¬ë… ì‹ ì²­ -->
  <section id="subscribe" class="subscription section">
    <div class="container">
      <h2>ì •ê¸°êµ¬ë…</h2>
      <form id="subscriptionForm">
  <div id="pet-forms">
    <div class="pet-block">
      <h3>ë°˜ë ¤ë™ë¬¼ 1 ì •ë³´</h3>
      <input type="text" name="pet_name[]" placeholder="ì´ë¦„" required />
      <input type="number" name="pet_age[]" placeholder="ë‚˜ì´ (ë…„)" required />
      <input type="number" name="pet_weight[]" placeholder="ëª¸ë¬´ê²Œ (kg)" step="0.1" required />
      <input type="number" name="pet_height[]" placeholder="í‚¤ (cm)" required />
    </div>
  </div>
  <button type="button" class="btn" onclick="addPetForm()">â• ë°˜ë ¤ë™ë¬¼ ì¶”ê°€</button>
  <br/><br/>
  <button type="button" class="btn" id="stripeCheckoutBtn">Stripeë¡œ ê²°ì œí•˜ê¸°</button>
</form>
<script>
  function addPetForm() {
    const container = document.getElementById("pet-forms");
    const index = container.children.length + 1;
    const div = document.createElement("div");
    div.classList.add("pet-block");
    div.innerHTML = `
      <h3>ë°˜ë ¤ë™ë¬¼ ${index} ì •ë³´</h3>
      <input type="text" name="pet_name[]" placeholder="ì´ë¦„" required />
      <input type="number" name="pet_age[]" placeholder="ë‚˜ì´ (ë…„)" required />
      <input type="number" name="pet_weight[]" placeholder="ëª¸ë¬´ê²Œ (kg)" step="0.1" required />
      <input type="number" name="pet_height[]" placeholder="í‚¤ (cm)" required />
    `;
    container.appendChild(div);
  }
</script>
    </div>
  </section>

  <!-- ë¬¸ì˜í•˜ê¸° -->
  <section id="contact" class="contact section">
    <div class="container">
      <h2>ë¬¸ì˜í•˜ê¸°</h2>
      <form action="email_auto_response.php" method="post" id="contactForm">
        <input type="text" name="contact_name" placeholder="ì´ë¦„" required />
        <input type="email" name="contact_email" placeholder="ì´ë©”ì¼" required />
        <input type="text" name="contact_subject" placeholder="ì œëª©" required />
        <textarea name="contact_message" placeholder="ë©”ì‹œì§€" required></textarea>
        <button type="submit" class="btn">ë¬¸ì˜ ë³´ë‚´ê¸°</button>
      </form>
    </div>
  </section>

<!-- GPT ê¸°ë°˜ ì œí’ˆ ì¶”ì²œ -->
<section id="gpt-recommend" class="section">
  <div class="container">
    <h2>ğŸ§  AI ì¶”ì²œ ê°„ì‹</h2>
    <div id="gpt-product-suggestion" style="background:#f1f1f1; padding:20px; border-radius:10px; min-height:100px; font-size:1.1rem;">
      ğŸ¤– ê°„ì‹ ì¶”ì²œì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...
    </div>
  </div>
</section>
  <section id="chatbot" class="chatbot section">
    <div class="container">
      <h2>ğŸ¶ ì˜¨ë§ˆë£¨ AI ì±—ë´‡ ìƒë‹´</h2>
      <div id="chat-window" style="border:1px solid #ccc; padding:15px; height:300px; overflow-y:auto; background:#f9f9f9;"></div>
      <form id="chat-form" style="margin-top:10px;">
        <input type="text" id="chat-input" placeholder="ê¶ê¸ˆí•œ ì ì„ ì…ë ¥í•˜ì„¸ìš”..." style="width:80%; padding:10px;" required />
        <button type="submit" class="btn">ë³´ë‚´ê¸°</button>
      </form>
    </div>
  </section>
  <section id="dashboard" class="admin section">
    <div class="container">
      <h2>ë‚´ ë°˜ë ¤ë™ë¬¼ ê±´ê°• ë¶„ì„</h2>
      <canvas id="bmiChart" width="400" height="200"></canvas>
      <div id="ai-recommendation" style="margin-top: 20px; font-size: 1.1rem;"></div>
    </div>
  </section>

  <!-- í‘¸í„° -->
  <footer class="footer">
    <div class="container">
      <p>&copy; 2025 ì˜¨ë§ˆë£¨í«. All rights reserved.</p>
    </div>
  </footer>

  <!-- ê´€ë¦¬ì í˜ì´ì§€ ë§í¬ -->
  <script>
    if (window.location.pathname.includes('admin.html')) {
      document.body.innerHTML = `
        <div class="container">
          <h2>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h2>
          <p>êµ¬ë…ì/ë¬¸ì˜ ë‚´ì—­ì„ í™•ì¸í•˜ê³  ì œí’ˆ ì •ë³´ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”.</p>
          <table border="1" cellpadding="10">
            <thead>
              <tr><th>ì´ë¦„</th><th>ë‚˜ì´</th><th>ëª¸ë¬´ê²Œ</th><th>í‚¤</th><th>í”Œëœ</th></tr>
            </thead>
            <tbody id="adminTable">
              <tr><td>ì½©ì´</td><td>2</td><td>6kg</td><td>30cm</td><td>5ë§Œì›</td></tr>
              <tr><td>ëª½ì´</td><td>4</td><td>8kg</td><td>35cm</td><td>3ë§Œì›</td></tr>
              <tr><td>ë³´ë¦¬</td><td>1</td><td>4.5kg</td><td>25cm</td><td>10ë§Œì›</td></tr>
            </tbody>
          </table>
        </div>
      `;
    }
  </script>

  <!-- Stripe Checkout Script + ë¶„ì„ ì°¨íŠ¸ -->
  <script>
    const stripe = Stripe("pk_test_your_public_key_here");
    document.getElementById("stripeCheckoutBtn")?.addEventListener("click", async () => {
      const amount = document.querySelector('input[name="subscription_plan"]:checked')?.value || "30000";
      const response = await fetch("/create-checkout-session.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ amount: parseInt(amount) })
      });
      const data = await response.json();
      if (data.id) {
        stripe.redirectToCheckout({ sessionId: data.id });
      }
    });

    // ì‚¬ìš©ì ê±´ê°• ë¶„ì„ ì°¨íŠ¸
    document.addEventListener("DOMContentLoaded", () => {
      const petWeight = parseFloat(document.getElementById('pet_weight')?.value || 5);
      const petHeight = parseFloat(document.getElementById('pet_height')?.value || 30);
      const petAge = parseFloat(document.getElementById('pet_age')?.value || 2);
      const bmi = (petWeight / ((petHeight / 100) ** 2)).toFixed(1);

      const ctx = document.getElementById('bmiChart')?.getContext('2d');
      if (ctx) {
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['BMI', 'ì •ìƒ ë²”ìœ„'],
            datasets: [{
              data: [bmi, 22 - bmi],
              backgroundColor: ['#ff9900', '#eee']
            }]
          },
          options: {
            plugins: {
              title: {
                display: true,
                text: `í˜„ì¬ ë°˜ë ¤ë™ë¬¼ BMI: ${bmi}`
              },
              tooltip: {
                callbacks: {
                  label: (ctx) => `${ctx.label}: ${ctx.raw}`
                }
              }
            }
          }
        });

        // AI ì¶”ì²œ ë©”ì‹œì§€
        const msgBox = document.getElementById('ai-recommendation');
        if (bmi < 15) {
          msgBox.innerText = 'ğŸƒ ì²´ì¤‘ì´ ë§ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ê³ ë‹¨ë°± íŠ¸ë¦¿ì„ ì¶”ì²œë“œë¦½ë‹ˆë‹¤.';
        } else if (bmi >= 15 && bmi < 23) {
          msgBox.innerText = 'âœ… ê±´ê°•í•œ ìƒíƒœì…ë‹ˆë‹¤. í˜„ì¬ ì‹ë‹¨ì„ ìœ ì§€í•˜ì„¸ìš”!';
        } else {
          msgBox.innerText = 'âš ï¸ ê³¼ì²´ì¤‘ì…ë‹ˆë‹¤. ì¹¼ë¡œë¦¬ ì¡°ì ˆ ê°„ì‹ì„ ê¶Œì¥í•©ë‹ˆë‹¤.';
        }
      }
    });
  </script>

  <!-- Chatbot UI Script -->
  <script>
    const chatForm = document.getElementById("chat-form");
    const chatInput = document.getElementById("chat-input");
    const chatWindow = document.getElementById("chat-window");

    chatForm?.addEventListener("submit", async function(e) {
      e.preventDefault();
      const userMsg = chatInput.value;
      chatWindow.innerHTML += `<div><strong>ğŸ‘¤ ë‚˜:</strong> ${userMsg}</div>`;
      chatInput.value = "";

      const botMsg = await fetchGPTResponse(userMsg);
      chatWindow.innerHTML += `<div><strong>ğŸ¤– ì±—ë´‡:</strong> ${botMsg}</div>`;
      chatWindow.scrollTop = chatWindow.scrollHeight;

      // GPT ì œí’ˆ ì¶”ì²œ ë©”ì‹œì§€ë¥¼ ë°˜ì˜í•´ ì¶”ì²œ ë°•ìŠ¤ì— ì¶œë ¥
      const suggestBox = document.getElementById("gpt-product-suggestion");
      if (suggestBox && botMsg.toLowerCase().includes("ê°„ì‹")) {
        suggestBox.innerHTML = `${botMsg}<br><a href='product-detail.html' class='btn' style='margin-top:10px; display:inline-block;'>ğŸ›’ ì§€ê¸ˆ ì¶”ì²œ ì œí’ˆ ë³´ê¸°</a>`;
      }
    });

    async function fetchGPTResponse(message) {
  const response = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer YOUR_OPENAI_API_KEY"
    },
    body: JSON.stringify({
      model: "gpt-3.5-turbo",
      messages: [
        {
          role: "system",
          content: "ë‹¹ì‹ ì€ ë°˜ë ¤ë™ë¬¼ ê±´ê°• ìƒë‹´ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì²´ì¤‘, ë‚˜ì´, ì‹ìŠµê´€ ë“±ì„ ë°”íƒ•ìœ¼ë¡œ ì ì ˆí•œ ì¡°ì–¸ì„ ì œê³µí•©ë‹ˆë‹¤."
        },
        {
          role: "user",
          content: message
        }
      ]
    })
  });

  const data = await response.json();
  return data.choices?.[0]?.message?.content || "ì£„ì†¡í•©ë‹ˆë‹¤. ì‘ë‹µì„ ë°›ì•„ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
} else if (message.includes("ì˜ì–‘ì œ")) {
        return "ì¥ì–´ ë¶€ì‚°ë¬¼ ê°„ì‹ì€ ì²œì—° ì˜¤ë©”ê°€-3ê°€ í’ë¶€í•´ í”¼ë¶€ì™€ í„¸ì— ì¢‹ì•„ìš”!";
      } else {
        return "ê¶ê¸ˆí•˜ì‹  ë‚´ìš©ì„ ë” ìì„¸íˆ ì…ë ¥í•´ì£¼ì‹œë©´ ë„ì›€ë“œë¦´ê²Œìš”!";
      }
    }
  
  function addToCart(product) {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    cart.push({ name: product, quantity: 1 });
    localStorage.setItem('cart', JSON.stringify(cart));
    alert(`${product} ì¥ë°”êµ¬ë‹ˆì— ë‹´ê²¼ìŠµë‹ˆë‹¤!`);
  }
</script>
</body>
</html>
