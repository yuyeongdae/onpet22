<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¥ë°”êµ¬ë‹ˆ - ì˜¨ë§ˆë£¨í«</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="navbar">
    <div class="container">
      <a href="index.html" class="logo">ì˜¨ë§ˆë£¨í«</a>
      <nav>
        <ul class="nav-links">
          <li><a href="index.html">í™ˆ</a></li>
          <li><a href="product-detail.html">ì œí’ˆìƒì„¸</a></li>
          <li><a href="cart.html">ì¥ë°”êµ¬ë‹ˆ</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <section class="section">
    <div class="container">
      <h2>ğŸ›’ ë‚´ ì¥ë°”êµ¬ë‹ˆ</h2>
      <div id="cart-container"></div>

      <div style="margin-top: 30px;">
        <h3>ğŸ“¦ ì •ê¸°êµ¬ë… ì˜µì…˜</h3>
        <label><input type="radio" name="subscription" value="none" checked> ì¼íšŒì„± êµ¬ë§¤</label><br>
        <label><input type="radio" name="subscription" value="monthly"> ë§¤ì›” ìë™ ë°°ì†¡ (ì •ê¸°êµ¬ë…)</label>
      </div>
      <button id="checkout-button" class="btn">ğŸ’³ ê²°ì œí•˜ê¸°</button>
    </div>
      </section>

    <section class="section">
      <div class="container">
        <h2>ğŸ’³ ê²°ì œ ë‚´ì—­</h2>
        <div id="payment-history">
          <p>ìµœê·¼ ê²°ì œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
        <div style="margin-top: 30px;">
          <h3>ğŸ›‘ ì •ê¸°êµ¬ë… ì·¨ì†Œ</h3>
          <button class="btn" onclick="cancelSubscription()">ì •ê¸°êµ¬ë… í•´ì§€í•˜ê¸°</button>
        </div>
      </div>
    </section>

<section class="section">
  <div class="container">
    <h2>ğŸ“‹ ê´€ë¦¬ì êµ¬ë… í˜„í™©</h2>
    <table border="1" cellpadding="8" style="width:100%; text-align:left;">
      <thead>
        <tr>
          <th>íšŒì›ID</th>
          <th>ìƒí’ˆëª…</th>
          <th>ìˆ˜ëŸ‰</th>
          <th>êµ¬ë… ìƒíƒœ</th>
          <th>Stripe êµ¬ë… ID</th>
          <th>ê´€ë¦¬</th>
        </tr>
      </thead>
      <tbody id="admin-subscription-table">
        <!-- Stripe ì‹¤ì‹œê°„ êµ¬ë… ìƒíƒœ ì—°ë™ -->
      </tbody>
      <script>
        fetch('/get-subscription-status.php')
          .then(res => res.json())
          .then(data => {
            const table = document.getElementById('admin-subscription-table');
            if (Array.isArray(data)) {
              table.innerHTML = data.map(sub => `
                <tr>
                  <td>${sub.user_id}</td>
                  <td>${sub.product}</td>
                  <td>${sub.quantity}</td>
                  <td>${sub.status}</td>
                  <td>${sub.stripe_subscription_id}</td>
                  <td>
                    ${sub.status === 'active'
                      ? `<button class="btn" onclick="cancelSub('${sub.stripe_subscription_id}')">í•´ì§€</button>`
                      : '<span style="color:#999">í•´ì§€ ì™„ë£Œ</span>'}
                  </td>
                </tr>`).join('');
            } else {
              table.innerHTML = '<tr><td colspan="6">êµ¬ë… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            }
          });

        function cancelSub(subscriptionId) {
          fetch('/cancel-subscription.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: subscriptionId })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              alert('êµ¬ë…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
              location.reload();
            } else {
              alert('ì·¨ì†Œ ì‹¤íŒ¨: ' + data.error);
            }
          });
        }
      </script>
    </table>
  </div>
</section>

<script>
    const cartContainer = document.getElementById('cart-container');
    const checkoutBtn = document.getElementById('checkout-button');
    const cart = JSON.parse(localStorage.getItem('cart')) || [];

    function renderCart() {
      if (cart.length === 0) {
        cartContainer.innerHTML = '<p>ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>';
        checkoutBtn.style.display = 'none';
        return;
      }
      let html = '<table><thead><tr><th>ìƒí’ˆëª…</th><th>ìˆ˜ëŸ‰</th><th>ê°€ê²©</th><th>ì‚­ì œ</th></tr></thead><tbody>';
      let total = 0;
      cart.forEach((item, index) => {
        const price = item.name.includes('íŠ¸ë¦¿') ? 10000 : item.name.includes('ìŠ¤í‹±') ? 12000 : 14000;
        total += price * item.quantity;
        html += `<tr>
          <td>${item.name}</td>
          <td>${item.quantity}</td>
          <td>${(price * item.quantity).toLocaleString()}ì›</td>
          <td><button onclick="removeItem(${index})">âŒ</button></td>
        </tr>`;
      });
      html += `</tbody></table><p style='text-align:right; font-size:1.1rem; margin-top:10px;'>ì´í•©ê³„: <strong>${total.toLocaleString()}ì›</strong></p>`;
      cartContainer.innerHTML = html;
    }

    function removeItem(index) {
      cart.splice(index, 1);
      localStorage.setItem('cart', JSON.stringify(cart));
      renderCart();
    }

    checkoutBtn.addEventListener('click', () => {
      const isSubscribed = document.querySelector('input[name="subscription"]:checked')?.value === 'monthly';
      if (isSubscribed) {
        alert('ì •ê¸°êµ¬ë… ê²°ì œë¡œ ì´ë™í•©ë‹ˆë‹¤. (Stripe ì—°ë™ ì˜ˆì •)');
        fetch('/create-subscription-session.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cart })
        })
        .then(res => res.json())
        .then(data => {
          if (data.id) {
            location.href = `https://checkout.stripe.com/pay/${data.id}`;
          } else {
            alert('ì •ê¸°ê²°ì œ ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨');
          }
        });
      } else {
        alert('ì¼íšŒì„± ê²°ì œ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
        fetch('/create-checkout-session.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cart })
        })
        .then(res => res.json())
        .then(data => {
          if (data.id) {
            location.href = `https://checkout.stripe.com/pay/${data.id}`;
          } else {
            alert('ì¼ë°˜ ê²°ì œ ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨');
          }
        });
      }
      // ì‹¤ì œ Stripe ê²°ì œ API í˜¸ì¶œ ì½”ë“œ ì‚½ì… ê°€ëŠ¥
    });

    renderCart();
  function cancelSubscription() {
  fetch('/cancel-subscription.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' }
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert('ì •ê¸°êµ¬ë…ì´ ì„±ê³µì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
    } else {
      alert('êµ¬ë… ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  });
}

// ì¶”í›„ ê²°ì œ ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸° ì—°ë™ ê°€ëŠ¥

</body>
</html>
